groups:
  - name: shibboleth-idp-alerts
    rules:
      # IdP 서비스 다운
      - alert: ShibbolethIdPDown
        expr: up{job="shibboleth-idp"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Shibboleth IdP 다운 ({{ $labels.school }})"
          description: "{{ $labels.school }}의 Shibboleth IdP가 1분 이상 응답하지 않습니다."

      # 메모리 사용률 높음
      - alert: ShibbolethHighMemoryUsage
        expr: shibboleth_memory_usage_ratio > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "IdP 메모리 사용률 높음 ({{ $labels.school }})"
          description: "{{ $labels.school }}의 메모리 사용률이 {{ $value | printf \"%.0f\" }}% 이상입니다."

      # 메타데이터 새로고침 실패
      - alert: ShibbolethMetadataRefreshError
        expr: shibboleth_metadata_has_error == 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "메타데이터 새로고침 오류 ({{ $labels.federation }})"
          description: "{{ $labels.federation }} 메타데이터 새로고침에 오류가 발생했습니다."

      # 메타데이터 만료 임박 (7일 이내)
      - alert: ShibbolethMetadataExpiringSoon
        expr: (shibboleth_metadata_valid_until_timestamp - time()) < 604800
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "메타데이터 만료 임박 ({{ $labels.federation }})"
          description: "{{ $labels.federation }} 메타데이터가 곧 만료됩니다. 남은 시간: {{ $value | humanizeDuration }}"

      # 서비스 리로드 실패
      - alert: ShibbolethServiceReloadFailed
        expr: shibboleth_service_reload_success == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "서비스 리로드 실패 ({{ $labels.service }})"
          description: "{{ $labels.service }} 서비스의 리로드가 실패했습니다."

      # 인증 실패율 높음 (10% 이상)
      - alert: ShibbolethHighAuthFailureRate
        expr: |
          sum by (instance, school, method) (rate(shibboleth_authentication_total{result="failures"}[5m]))
          /
          sum by (instance, school, method) (rate(shibboleth_authentication_total[5m]))
          > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "인증 실패율 높음 ({{ $labels.school }})"
          description: "{{ $labels.school }}의 {{ $labels.method }} 인증 실패율이 10% 이상입니다."

  - name: ssl-certificate-alerts
    rules:
      # SSL 인증서 만료 임박 (30일 이내)
      - alert: SSLCertificateExpiringSoon
        expr: probe_ssl_earliest_cert_expiry - time() < 2592000
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "SSL 인증서 만료 임박 ({{ $labels.school }})"
          description: "{{ $labels.school }}의 SSL 인증서가 곧 만료됩니다. 남은 시간: {{ $value | humanizeDuration }}"

      # SSL 인증서 만료 임박 (7일 이내)
      - alert: SSLCertificateExpiryCritical
        expr: probe_ssl_earliest_cert_expiry - time() < 604800
        for: 1h
        labels:
          severity: critical
        annotations:
          summary: "SSL 인증서 긴급 ({{ $labels.school }})"
          description: "{{ $labels.school }}의 SSL 인증서가 7일 이내 만료됩니다. 즉시 갱신이 필요합니다."

  - name: http-service-alerts
    rules:
      # HTTP 엔드포인트 다운
      - alert: HTTPEndpointDown
        expr: probe_success{job="blackbox-http"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "HTTP 엔드포인트 다운 ({{ $labels.school }})"
          description: "{{ $labels.target }} 엔드포인트가 응답하지 않습니다."

      # TCP 포트 연결 실패
      - alert: TCPPortDown
        expr: probe_success{job="blackbox-tcp"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "TCP 포트 다운 ({{ $labels.school }})"
          description: "{{ $labels.target }} 포트 연결에 실패했습니다."

  - name: system-alerts
    rules:
      # CPU 사용률 높음
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPU 사용률 높음 ({{ $labels.instance }})"
          description: "CPU 사용률이 {{ printf \"%.1f\" $value }}%입니다."

      # 디스크 사용률 높음
      - alert: HighDiskUsage
        expr: 100 - ((node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100) > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "디스크 사용률 높음 ({{ $labels.instance }})"
          description: "루트 파티션 사용률이 {{ printf \"%.1f\" $value }}%입니다."

      # 메모리 사용률 높음
      - alert: HighMemoryUsage
        expr: 100 - ((node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100) > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "시스템 메모리 사용률 높음 ({{ $labels.instance }})"
          description: "메모리 사용률이 {{ printf \"%.1f\" $value }}%입니다."
